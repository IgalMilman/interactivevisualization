{% extends "_base.html" %}
{% load staticfiles %}
{% block page_title %} VAP {% endblock %}
{% block subtitle %}Visual analytics platform home{% endblock %}

{% block extra_css %}{% endblock %}

{% block body %}
<h1>Welcome to Visual Analytics Platform!</h1>
    <div class="vap_container">
        <div class="container">
          <div class="row">
            <div class="col-sm">
                <div class="card border-dark mb-3">
                    <div class="card-header">Get Dataset</div>
                    <div class="card-body">
                        <form action="" method="POST" enctype='multipart/form-data'>
                            {% csrf_token %}
                            <div class="custom-file">
							  <input type="hidden" name="formt" value="newfile">
                              <input type="file" class="custom-file-input" id="customFile" name="customFile">
                              <label class="custom-file-label" for="customFile">Choose file</label>
                            </div>
                            <input type="submit" value="Submit">
                        </form>
                        <div class="pre-scrollable" id="initial-dataset"></div>
                    </div>
                </div>
            </div>
          </div>
          <div class="row">

          </div>
        </div>
        <div id="controls"></div>
        <div class="container">
            <div class="row">
                <div class="col-3" id="controllers">
                    <div class="card border-dark mb-3">
                        <div class="card-header">Dimensions</div>
                        <div class="card-body">
                            <form id="dimensions_form">
                                <div class="form-group form-inline vap-controllers">
                                    <select class="form-control form-control-sm text-danger" id="x_dim">
                                    </select>
                                </div>
                                <div class="form-group form-inline vap-controllers">
                                    <select class="form-control form-control-sm text-primary" id="y_dim">
                                    </select>
                                </div>
                                <div class="form-group form-inline vap-controllers">
                                    <select class="form-control form-control-sm text-success" id="z_dim">
                                    </select>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm vap-controllers" id="change_dim_btn">Change Dimensions</button>
                            </form>
                        </div>
                    </div>
                    <div class="card border-dark mb-3">
                        <div class="card-header">Clustering</div>
                        <div class="card-body">
                            <form action="" id="cluster_form" method="POST">
                                {% csrf_token %}
							    <input type="hidden" name="formt" value="cluster">
                                {% if saveid %}
                                <input type="hidden" name="fdid" value="{{ saveid }}">
                                {% endif %}
                                <div class="form-group" id="clustering">
                                </div>
                                <!--<button type="button" class="btn btn-secondary btn-sm vap-controllers" id="cluster_btn">Clustering</button>-->
                                <input type="submit" class="btn btn-secondary btn-sm vap-controllers" value="Clusterize">
                            </form>
                        </div>
                    </div>
                    <div class="card border-dark mb-3">
                        <div class="card-header">Sphere Radius</div>
                        <div class="card-body">
                            <form id="radius_form">
                                <div class="form-group">
                                    <label for="radiusRange">Spheres Radius</label>
                                    <input type="range" class="custom-range" min="0" max="3" step="0.1" id="radiusRange">
                                    <button type="button" class="btn btn-secondary btn-sm vap-controllers" id="changeRadiusBtn">Change Radius</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card border-dark mb-3">
                        <div class="card-header">Manage scene</div>
                        <div class="card-body">
                            <form>
                              <button type="button" class="btn btn-secondary btn-sm vap-controllers" id="resetBtn">Reset Camera</button>
                              <button type="button" class="btn btn-secondary btn-sm vap-controllers" id="printBtn">Print Results</button>
                          </form>
                        </div>
                    </div>
                </div>
                <div class="col-11 mainPicture" id="picture">
                    <div id="gui_container"></div>
                </div>
            </div>
        </div>
        <div class="container pre-scrollable">
            <div class="card border-dark mb-3">
                <div class="card-header">Clustering results</div>
                <div class="card-body" id="output">
                </div>
            </div>
        </div>
	</div>
{% block extra_js %}
<script src="{% static "js/three.js" %}"></script>
<script src="{% static "js/controls/OrbitControls.js" %}"></script>
<script src="{% static "js/VAP/main.js" %}"></script>
<script src="{% static "js/dat.gui.min.js" %}"></script>
{% endblock %}
	<script>
    // SETTING:
		countOfEdges=24;
		function onSceneResize() {
			scene.onResize();
		}
		var scene=new Scene(document.getElementById("picture"), document.getElementById("controls"), document.getElementById("output"), 0.75, countOfEdges);
		animate();
		init();

		window.addEventListener( "resize", onSceneResize, false );

		function init() {
		    clustering_parameters=[['KMeans', 'K means', {'name':'numberofcl', 'label':'Number of clusters', 'type':'number', 'attributes':[['placeholder', '5']]}],['DBScan', 'DB scan']]
            createClusterElements(document.getElementById('clustering'), clustering_parameters);
            var dimNames = {{ dim_names|safe }};
            var dataArray = {{ norm_slice|safe }};
            var statistics = {{ metrics|safe }};
            scene.setDimNames(dimNames);
            var new_dataArray = fix_array(dataArray);
            printStats(statistics, dimNames);
            {% if cluster_ready %}
            var clusters = {{ clusters|safe }};
            var clusters_color_scheme = getColorScheme({{ count_of_clusters|safe }});
            {% endif %}
            scene.setDataArray(new_dataArray);

			for ( i = 0; i < new_dataArray.length; i++ ){
                {% if cluster_ready %}
				scene.createSphere( new_dataArray[ i ], clusters_color_scheme[clusters[i]].clone() );
                {% else %}
				scene.createSphere( new_dataArray[ i ], new THREE.Color( 1,1,1 ) );
				{% endif %}
			}
			scene.createControlElements();

		}
		function animate() {

			scene.animate();
			requestAnimationFrame( animate );

		}

        function fix_array(data) {
            var new_array = new Array(data.length);
            for (var i = 0; i < data.length; i++) {
                var values = [];
                for (var j = 0; j < data[i][1][0].length; j++) {
                    var current_item = data[i][1][0][j];
                    values[j] = current_item
                }
                new_array[i] = [data[i][0].toString(), values];
            }
            return new_array;
        }

        function printStats(stats, dimensions){
            var initial_dataset = document.getElementById("initial-dataset");
            var table = document.createElement("table");
            table.setAttribute("id", "dataset");
            table.classList.add("table", "table-sm", "table-hover");
            var thead = document.createElement("thead");
            table.appendChild(thead);
            var row = document.createElement("tr");
            thead.appendChild(row);
            var th = document.createElement("th");
            th.innerText = "  ";
            row.appendChild(th);
            for(var i = 0; i < dimensions.length; ++i ) {
                th = document.createElement("th");
                th.innerText = dimensions[i].toString();
                row.appendChild(th);
            }
            var tbody = document.createElement("tbody");
            table.appendChild(tbody);
            for ( var j=0; j < stats[0].length; ++j ) {
                var obj	= stats[1][j];
                row = document.createElement("tr");

                th = document.createElement("th");
                th.innerText = stats[0][j];
                row.appendChild(th);

                for(var i = 0; i < obj.length; i++ ) {
                    var td = document.createElement("td");
                    td.innerText = obj[i];
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            }
            initial_dataset.appendChild(table);
         }
	</script>
{% endblock %}

{% block helptext %}{% endblock %}

